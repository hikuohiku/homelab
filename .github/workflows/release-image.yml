name: Release NixOS Image

on:
  workflow_dispatch:
    inputs:
      update_type:
        description: "Version update type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate next version
        id: version
        run: |
          # Get latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $LATEST_TAG"

          # Parse version (remove 'v' prefix)
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          # Bump version based on update type
          case "${{ inputs.update_type }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Build qcow2 image
        run: |
          nix build ./nix/images/proxmox-cloud#packages.x86_64-linux.qcow2 --no-link --print-out-paths > result-path.txt
          RESULT_PATH=$(cat result-path.txt)
          cp "${RESULT_PATH}/nixos.qcow2" nixos-proxmox-cloud.qcow2

      - name: Compress with zstd
        run: |
          zstd -T0 nixos-proxmox-cloud.qcow2 -o nixos-proxmox-cloud.qcow2.zst
          ls -lh nixos-proxmox-cloud.qcow2*

      - name: Generate checksum
        run: |
          sha256sum nixos-proxmox-cloud.qcow2.zst > nixos-proxmox-cloud.qcow2.zst.sha256
          cat nixos-proxmox-cloud.qcow2.zst.sha256

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: ${{ steps.version.outputs.version }}
          body: |
            ## NixOS Proxmox Cloud Image

            ### Files
            - `nixos-proxmox-cloud.qcow2.zst` - zstd compressed qcow2 disk image
            - `nixos-proxmox-cloud.qcow2.zst.sha256` - SHA256 checksum

            ### Usage with Terraform
            ```hcl
            variable "nixos_image_version" {
              default = "${{ steps.version.outputs.version }}"
            }
            ```

            Proxmox will automatically decompress the image when downloading.
          files: |
            nixos-proxmox-cloud.qcow2.zst
            nixos-proxmox-cloud.qcow2.zst.sha256
          draft: false
          prerelease: false
