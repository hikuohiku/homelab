image:
  flavor: apache

replicaCount: 1

nextcloud:
  host: nextcloud.tailae6c2.ts.net
  existingSecret:
    enabled: true
    secretName: nextcloud-admin
    usernameKey: username
    passwordKey: password
  datadir: /var/www/html/data

  # Mail disabled
  mail:
    enabled: false

  # OIDC configuration for user_oidc app
  configs:
    oidc.config.php: |-
      <?php
      $CONFIG = array (
        'user_oidc' => array (
          'single_logout' => false,
          'auto_provision' => true,
          'soft_auto_provision' => true,
        ),
        'allow_user_to_change_display_name' => false,
      );

  # Post-installation hook to configure OIDC provider
  hooks:
    post-installation: |-
      #!/bin/bash
      echo "Installing and configuring user_oidc app..."

      # Install user_oidc app
      php occ app:install user_oidc || true
      php occ app:enable user_oidc || true

      # Check if provider already exists
      if ! php occ user_oidc:provider Dex 2>/dev/null | grep -q "Dex"; then
        echo "Creating OIDC provider..."
        php occ user_oidc:provider Dex \
          --clientid="nextcloud" \
          --clientsecret="${NEXTCLOUD_OIDC_CLIENT_SECRET}" \
          --discoveryuri="https://dex.tailae6c2.ts.net/.well-known/openid-configuration" \
          --scope="openid email profile" \
          --unique-uid="0" \
          --mapping-uid="preferred_username" \
          --mapping-email="email" \
          --mapping-displayname="name"
      else
        echo "OIDC provider already exists, updating..."
        php occ user_oidc:provider Dex \
          --clientid="nextcloud" \
          --clientsecret="${NEXTCLOUD_OIDC_CLIENT_SECRET}" \
          --discoveryuri="https://dex.tailae6c2.ts.net/.well-known/openid-configuration" \
          --scope="openid email profile" \
          --unique-uid="0" \
          --mapping-uid="preferred_username" \
          --mapping-email="email" \
          --mapping-displayname="name"
      fi

      echo "OIDC configuration complete"

  # Environment variables for OIDC
  extraEnv:
    - name: NEXTCLOUD_OIDC_CLIENT_SECRET
      valueFrom:
        secretKeyRef:
          name: nextcloud-oidc
          key: client-secret

# SQLite (internal database)
internalDatabase:
  enabled: true

# External database disabled
postgresql:
  enabled: false

mariadb:
  enabled: false

# Redis enabled
redis:
  enabled: true
  auth:
    enabled: true
  master:
    persistence:
      enabled: true
      storageClass: local-path
      size: 1Gi
  replica:
    replicaCount: 0

# Persistence with local-path
persistence:
  enabled: true
  storageClass: local-path
  accessMode: ReadWriteOnce
  size: 8Gi

  nextcloudData:
    enabled: true
    storageClass: local-path
    accessMode: ReadWriteOnce
    size: 50Gi

# Ingress disabled (using separate Tailscale Ingress)
ingress:
  enabled: false

# Metrics disabled
metrics:
  enabled: false

# Cronjob for background tasks
cronjob:
  enabled: true

# Resources
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 128Mi

# Liveness and readiness probes
livenessProbe:
  enabled: true
  initialDelaySeconds: 30
  periodSeconds: 15
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  enabled: true
  initialDelaySeconds: 30
  periodSeconds: 15
  timeoutSeconds: 5
  failureThreshold: 3

# Update strategy
strategy:
  type: Recreate
